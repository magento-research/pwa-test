###########################################################################################
# This script waits for 2 containers to start, selenium and MFTF, when running 
# docker-compose up. After the two containers are running the script waits for the MFTF
# test container to exit after the test run completes. The last container running is selenium, 
# which needs to be stopped and, finally, the test results are checked for failures to exit 
# the script with the correct exit status.
###########################################################################################

count_containers () {
  CONTAINER_COUNT=$(docker ps -q | wc -l)
}
count_containers

# first wait for both containers to start
while [ $CONTAINER_COUNT -lt 2 ]; do
  echo "waiting for containers to start: $CONTAINER_COUNT containers running..."
  sleep 10;
  count_containers
done
echo "both containers are up: $CONTAINER_COUNT containers running..."
# after both containers start, when the count drops to 1 then the tests finished
while [ $CONTAINER_COUNT -gt 1 ]; do
  sleep 10;
  count_containers
done
echo -e "Containers running: $CONTAINER_COUNT\ntests have finished! stopping selenium..."
docker stop $(docker ps -q)

# determine if there were failures
FAIL_FILE="./dev/tests/acceptance/tests/_output/failed"
if [ -f $FAIL_FILE ]; then
    echo "there were failed tests!"
    cat $FAIL_FILE
    sh ./.bin/kill.sh
    exit 1
fi

exit 0
